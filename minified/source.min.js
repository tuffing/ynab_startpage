class YnabRequest{static request_from_endpoint(endpoint,ynabAuth){let url=`https://api.youneedabudget.com/v1/${endpoint}`;return new Promise(function(resolve,reject){var headers=new Headers;headers.append("Authorization",`bearer ${ynabAuth.get_access_token()}`);const request=new Request(url,{method:"GET",headers:headers});fetch(request).then(response=>{if(200===response.status)return response.json();throw reject(response),new Error("Ynab failed")}).then(response=>{console.debug(response),resolve(response)}).catch(error=>{console.error(error),reject(error)})})}}class YnabConfigManager{constructor(auth,budgetManager,categoryManager){this.ynabAuth=auth,this.budgetManager=budgetManager,this.categoryManager=categoryManager,document.querySelector("#Setup").addEventListener("click",()=>this.toggle_config_screen()),document.querySelector("#ConfigWrapper").addEventListener("click",()=>this.toggle_config_screen()),document.querySelector("#ConfigWrapper .close").addEventListener("click",()=>this.toggle_config_screen()),document.querySelector(".config-pane").addEventListener("click",()=>{event.stopPropagation()}),document.querySelector("#YnabFetchBudgets").addEventListener("click",()=>this.fetch_budgets()),document.querySelector("#YnabFetchCategories").addEventListener("click",()=>this.fetch_categories()),document.querySelector("#AuthKey").addEventListener("change",event=>this.set_auth_key(event)),this.fill_in_existing_fields()}toggle_config_screen(){const config_wrapper=document.querySelector("#ConfigWrapper");config_wrapper.classList.contains("show")?(config_wrapper.classList.remove("show"),config_wrapper.classList.add("hide"),this.categoryManager.get_selected_categories().length&&this.categoryManager.fetch_category_data_api()):(config_wrapper.classList.add("show"),config_wrapper.classList.remove("hide"))}fill_in_existing_fields(){const auth=document.querySelector("#AuthKey");auth.value="",this.ynabAuth.get_access_token()&&(auth.value=this.ynabAuth.get_access_token());const budgets=this.budgetManager.fetch_budgets_cached();budgets.length&&(document.querySelector("#NoBudgetAlert").classList.add("hide"),this.render_budget_list(budgets));const categories=this.categoryManager.fetch_categories_cached();"categories"in categories&&categories.categories.length&&(document.querySelector("#NoCategoriesAlert").classList.add("hide"),this.render_categories_list(categories))}set_auth_key(event){this.ynabAuth.set_access_token(event.currentTarget.value)}fetch_budgets(){this.budgetManager.fetch_budgets_api().then(budgets=>{this.render_budget_list(budgets)}).catch(()=>this.render_budget_list([]))}fetch_categories(){this.categoryManager.fetch_categories_api().then(categories=>{this.render_categories_list(categories)}).catch(()=>this.render_categories_list([]))}render_categories_list(categories){if(!("categories"in categories&&categories.categories.length))return document.querySelector("#NoCategoriesAlert").classList.remove("hide"),document.querySelector("#NoCategoriesAlert").classList.add("show"),void document.querySelector("#AvailableCategories").classList.add("hide");document.querySelector("#NoCategoriesAlert").classList.remove("show"),document.querySelector("#NoCategoriesAlert").classList.add("hide");let groupTemplates=document.querySelector("#CategoryGroupHeaderTemplate"),categoryTemplates=document.querySelector("#CategorySelectTemplate");document.querySelectorAll("#AvailableCategories optgroup, #AvailableCategories option").forEach(child=>child.remove());let category_wrapper=document.querySelector("#AvailableCategories");category_wrapper.classList.remove("hide");let selected_categories=this.categoryManager.get_selected_categories();categories.groups.forEach(group=>{let clone=document.importNode(groupTemplates.content,!0),opt_group=clone.querySelector("optgroup");opt_group.setAttribute("label",group.name),opt_group.setAttribute("id",`group-${group.id}`),category_wrapper.appendChild(clone)}),categories.categories.forEach(category=>{let clone=document.importNode(categoryTemplates.content,!0),option=clone.querySelector("option");option.setAttribute("value",category.id),option.textContent=category.name,selected_categories.includes(category.id)&&option.setAttribute("selected","selected"),document.querySelector(`#group-${category.group}`).appendChild(clone)}),document.querySelector("#AvailableCategories").addEventListener("change",event=>this.select_categories(event))}select_budget(event){this.budgetManager.set_selected_budget(event.currentTarget.value)}select_categories(event){let categories=[];for(let option of event.currentTarget.selectedOptions)categories.push(option.value);this.categoryManager.set_selected_categories(categories)}render_budget_list(budgets){if(!budgets.length)return void document.querySelector("#NoBudgetAlert").classList.add("show");document.querySelector("#NoBudgetAlert").classList.add("hide");let current_budget=this.budgetManager.get_selected_budget();var template=document.querySelector("#BudgetListTemplate");document.querySelectorAll("#AvailableBudgets input, #AvailableBudgets label").forEach(child=>child.remove());var budget_wrapper=document.querySelector("#AvailableBudgets");budgets.forEach(budget=>{var clone=document.importNode(template.content,!0);let label=clone.querySelector("label");label.textContent=budget.name,label.setAttribute("for",budget.id);let input=clone.querySelector("input");input.setAttribute("value",budget.id),input.setAttribute("id",budget.id),budget.id===current_budget&&input.setAttribute("checked","checked"),budget_wrapper.appendChild(clone)}),document.querySelectorAll("#AvailableBudgets input").forEach(child=>child.addEventListener("change",event=>this.select_budget(event)))}}class YnabCategoriesManager{constructor(auth,budgetManager){this.ynab_auth=auth,this.budgetManager=budgetManager}fetch_and_render(){document.querySelectorAll("#Categories .category").forEach(child=>child.remove());let dateString=localStorage.getItem("last_fetch");null!=this.get_selected_categories()&&this.get_selected_categories().length?!dateString||+dateString+36e5<Date.now()?this.fetch_category_data_api():this.fetch_category_data_cached():document.querySelector("#Categories").textContent="No categories set"}fetch_category_data_api(){let data=[],promises=[];this.get_selected_categories().forEach(category=>{let promise=new Promise((resolve,reject)=>{YnabRequest.request_from_endpoint(`budgets/${this.budgetManager.get_selected_budget()}/categories/${category}`,this.ynab_auth).then(json=>{if(!("data"in json&&"category"in json.data))return;let data_obj={name:json.data.category.name,id:json.data.category.id,budgeted:json.data.category.budgeted,balance:json.data.category.balance,spent:Math.abs(json.data.category.activity)};data.push(data_obj),resolve(data_obj)}).catch(err=>{reject(err)})});promises.push(promise)}),Promise.all(promises).then(()=>{data.sort(function(a,b){var nameA=a.name.toUpperCase(),nameB=b.name.toUpperCase();return nameA<nameB?-1:nameA>nameB?1:0}),localStorage.setItem("category_data",JSON.stringify(data)),localStorage.setItem("last_fetch",Date.now()),this.fetch_and_render()})}fetch_category_data_cached(){let data=JSON.parse(localStorage.getItem("category_data"));null!=data&&data.forEach(category=>this.render_single(category.name,category.budgeted,category.balance,category.spent))}fetch_categories_api(){var promise=YnabRequest.request_from_endpoint(`budgets/${this.budgetManager.get_selected_budget()}/categories`,this.ynab_auth);return new Promise((resolve,reject)=>{promise.then(json=>{"data"in json&&"category_groups"in json.data&&json.data.category_groups.length||reject();let groupNames=[],categories=[];json.data.category_groups.forEach(category_group=>{groupNames.push({id:category_group.id,name:category_group.name});let group_cats=this.process_category_group(category_group.categories);categories=categories.concat(group_cats)});let categoriesList={groups:groupNames,categories:categories};localStorage.setItem("categories_list",JSON.stringify(categoriesList)),resolve(categoriesList)}).catch(err=>{reject(err)})})}fetch_categories_cached(){let categories=JSON.parse(localStorage.getItem("categories_list"));return null==categories&&(categories=[]),categories}set_selected_categories(category_ids=[]){this.category_ids=category_ids,localStorage.setItem("category_ids",JSON.stringify(category_ids))}get_selected_categories(){return this.category_ids||(this.category_ids=JSON.parse(localStorage.getItem("category_ids")),this.category_ids)?this.category_ids:[]}process_category_group(group_data){let categories=[];return group_data.forEach(category=>{categories.push({name:category.name,id:category.id,group:category.category_group_id,budgeted:category.budgeted,balance:category.balance,spent:Math.abs(category.activity)})}),categories}render_single(name,budgeted,balance,spent){var template=document.querySelector("#YnabBlock"),category_wrapper=document.querySelector("#Categories"),clone=document.importNode(template.content,!0);clone.querySelector(".name").textContent=name;let percentage=spent/budgeted*100;clone.querySelector(".progress").setAttribute("stroke-dashoffset",251.2-251.2*percentage/100),percentage>55&&clone.querySelector(".progress").classList.add("nearing-complete"),percentage>75&&clone.querySelector(".progress").classList.add("nearing-complete-alert"),category_wrapper.appendChild(clone)}}class YnabBudgetsManager{constructor(auth,budgetManager){this.ynab_auth=auth,this.budgetManager=budgetManager}fetch_budgets_api(){var promise=YnabRequest.request_from_endpoint("budgets",this.ynab_auth);return new Promise((resolve,reject)=>{promise.then(json=>{let budgets=[];"data"in json&&"budgets"in json.data&&json.data.budgets.length||resolve(budgets),json.data.budgets.forEach(budget=>{budgets.push({id:budget.id,name:budget.name})}),this.save_budgets(budgets),resolve(budgets)}).catch(err=>{reject(err)})})}fetch_budgets_cached(){let budgets=JSON.parse(localStorage.getItem("budgets"));return null==budgets&&(budgets=[]),budgets}save_budgets(budgets){localStorage.setItem("budgets",JSON.stringify(budgets))}set_selected_budget(budget_id){this.budget_id=budget_id,localStorage.setItem("budget_id",budget_id)}get_selected_budget(){return this.budget_id||(this.budget_id=localStorage.getItem("budget_id")),this.budget_id}}class YnabAuth{constructor(access_token=null){null!=access_token&&this.set_access_token(access_token)}set_access_token(access_token){this.access_token=access_token,localStorage.setItem("token",access_token)}get_access_token(){return this.access_token=localStorage.getItem("token"),this.access_token}}let auth=new YnabAuth,budgets=new YnabBudgetsManager(auth),categories=new YnabCategoriesManager(auth,budgets),config=new YnabConfigManager(auth,budgets,categories);categories.fetch_and_render();